#! /bin/sh
# $Id$
# This script generates a file that references every star referenced
# in a makefile (normally by the PL_SRCS makefile variable).
#
# usage: genStarTable [-vars makefilevars] domain1 domain2
# If not specified, makefilevars defaults to "PL_SRCS".  It may specify
# more than one makefile variable.
#

cat > /tmp/$$.hdr << EOF
/* This file contains a table of the official $1 stars.  Its purpose is
 * to force the linker to retrieve the corresponding stars from their
 * library.
 *
 * DO NOT EDIT THIS FILE!  It is generated automatically from the
 * make.template file's definition of PL_SRCS.
 */

#define STR extern char *

EOF

makevarlist="PL_SRCS"
if [ "$1" = "-vars" ] ; then
    shift; makevarlist=$1; shift
fi

pp=ZZZ
if [ $# > 1 ] ; then
    pp=$2
fi

d3=ZZZ
if [ $# > 2 ] ; then 
    d3=$3
fi

cp /dev/null /tmp/$$.p1
echo 'static char** nm_table[] = {' > /tmp/$$.p2

for makevar in $makevarlist ; do
	sed -n	-e "s/^[ ]*$1/STR star_nm_${1}/g" \
		-e "s/^[ ]*$pp/STR star_nm_${pp}/g" \
		-e "s/^[ ]*$d3/STR star_nm_${d3}/g" \
		-e "s/[ ]+$1/STR star_nm_${1}/g" \
		-e "s/[ ]+$pp/STR star_nm_${pp}/g" \
		-e "s/[ ]+$d3/STR star_nm_${d3}/g" \
		-e "s?${makevar}.*?/\* declare ${makevar} symbols \*/?" \
		-e "s/\.[a-z]*/;/g" \
		-e 's/\\$//' \
		-e "/^.. declare/,/^\$/p" make.template >> /tmp/$$.p1

	sed -n	-e "s/^[ ]*$1/\&star_nm_${1}/g" \
		-e "s/^[ ]*$pp/\&star_nm_${pp}/g" \
		-e "s/^[ ]*$d3/\&star_nm_${d3}/g" \
		-e "s/[ ]+$1/\&star_nm_${1}/g" \
		-e "s/[ ]+$pp/\&star_nm_${pp}/g" \
		-e "s/[ ]+$d3/\&star_nm_${d3}/g" \
		-e "s?^${makevar}.*=?/\* reference ${makevar} symbols \*/?" \
		-e "s/\.[a-z]*/,/g" \
		-e 's/\\$//' \
		-e "/^.. reference/,/^\$/p" make.template >> /tmp/$$.p2
done

cat /tmp/$$.hdr /tmp/$$.p1 /tmp/$$.p2
echo '};'

rm /tmp/$$.hdr /tmp/$$.p1 /tmp/$$.p2
exit
