##########################################################################
# Version: $Id$
# Author: John Reekie
#
# Copyright (c) 1996-1997 The Regents of the University of California.
# All rights reserved.
# 
# Permission is hereby granted, without written agreement and without
# license or royalty fees, to use, copy, modify, and distribute this
# software and its documentation for any purpose, provided that the above
# copyright notice and the following two paragraphs appear in all copies
# of this software.
# 
# IN NO EVENT SHALL THE UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY
# FOR DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
# ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
# THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
# 
# THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY WARRANTIES,
# INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE
# PROVIDED HEREUNDER IS ON AN "AS IS" BASIS, AND THE UNIVERSITY OF
# CALIFORNIA HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES,
# ENHANCEMENTS, OR MODIFICATIONS.
#                                                         COPYRIGHTENDKEY
##########################################################################


##########################################################################
#### EditGraph
#
# _EditGraph_ is an editor for the _GraphLayout_ model. It edits
# directed graphs.
#
class ::tycho::EditGraph {
    inherit ::tycho::TCanvas

    constructor {args} {}
    destructor {}
    
    #################################################################
    ####                        options                          ####

    # The layout model
    itk_option define -layout layout Layout {}
    
    # The graph model
    itk_option define -graph graph Graph {}
    
    # The icon index
    itk_option define -icons icons Icons {}
    
    #################################################################
    ####                     public methods                      ####

    # Remove an item from the selection
    method deselect {id}

    # Load a new layout
    method loadLayout {}

    # Add a vertex to the selection
    method select {id}

    # Clear the selection
    method selectionclear {}

    # Create another editor.
    method clone {}

    # Call the model
    method model {method args}

    # Start creating a new edge
    method newclick {item x y}

    # Continue move the end of the new edge
    method newdrag {item x y}

    # Stop moving a new edge
    method newrelease {x y}

    # Handle change notification from the graph layout model
    method notify {method args}

    # Move mouse over a port
    method portenter {}

    # Move mouse away from a port
    method portleave {}

    # Update the layout model
    method updateLayout {}

    # Make a new vertex
    method vertex {name x y}

    # Start moving a vertex
    method vertexclick {tag x y args}

    # Continue moving a vertex item
    method vertexdrag {tag x y}

    # Stop moving a vertex
    method vertexrelease {tag x y}

    # Return the vertices and edges with a given tag.
    method withtag {tag}

    #################################################################
    ####                  protected methods                      ####
    
    # Add a tag to all indicated vertices and edges.
    protected method _addtag {tag args}

    # Clear data from this editor (Note: not the viewer)
    method _clear {}

    # Remove an item from the selection
    protected method _deselect {name}

    # Delete a tag from all items.
    protected method _dtag {tag}

    # Add a new edge
    protected method _edge {name spec args}

    # Move an item
    protected method _move {tag x y}

    # Start moving an item
    protected method _moveclick {tag x y args}

    # Continue moving an item
    protected method _movedrag {tag x y}

    # Stop moving an item
    protected method _moverelease {tag x y}

    # Add a new port to a vertex
    protected method _portin {context name coords args}

    # Reshape an item
    protected method _reshape {name x y args}

    # Start reshaping an item
    protected method _reshapeclick {name x y args}

    # Continue reshaping an item
    protected method _reshapedrag {name x y}

    # Stop reshaping an item
    protected method _reshaperelease {name x y}

    # Add a vertex to the selection
    protected method _select {name}

    # Clear the selection
    protected method _selectionclear {foo}

    # Add a new vertex to the view
    protected method _vertex {name coords args}

    # Configure a vertex
    protected method _vertexconfigure {name args}
    
    # Add an icon to a menu
    protected method addIconEntry {menu icons index}

    #################################################################
    ####                 protected variables                     ####
    
    # The mapping from vertex and edge names to item IDs
    protected variable _itemID

    # The mapping from item IDs to vertex and edge names
    protected variable _itemname

    # The interactor to connect things around
    protected variable follower

    # The interactor to connect edges
    protected variable dropper

    # Storage for temporary variables
    protected variable _scratch

    #################################################################
    ####                   private methods                       ####

    # Initialize the menubar
    private method initializeMenubar {}
}

#####################################################################
#### -layout configuration
# Subscribe to the layout model. Note: there will be a problem here
# if the model is changed, since the old one is not unsubscribed...
#
configbody ::tycho::EditGraph::layout {
    if { $itk_option(-layout) != "" } {
        $itk_option(-layout) subscribe $this all
    }
    # If the graph model already exists, load the layout
    if { $itk_option(-graph) != "" } {
        loadLayout
    }
}

########################################################################
#### constructor
#
body ::tycho::EditGraph::constructor {args} {
    # Evaluate options
    eval itk_initialize $args

    # If there is not already a graph model, create one
    if { $itk_option(-graph) == "" } {
	configure -graph \
                [uplevel #0 ::tycho::KeyedDigraph [::tycho::autoName graph]]
    }

    # If there is not already a layout model, create one
    if { $itk_option(-layout) == "" } {
	configure -layout \
                [uplevel #0 ::tycho::GraphLayout \
                [::tycho::autoName layout] \
                -primaryview $this \
                -graph $itk_option(-graph)]
    }

    # If there is not already an icon index, create one
    if { $itk_option(-icons) == "" } {
	set icons [uplevel #0 ::tycho::IconIndex \
                [::tycho::autoName icons] \
                -datafile {$TYCHO/editors/visedit/icons.tim}]
	$icons load
	configure -icons $icons
    }

    # Add menu development stuff
    if {$myMenubar != {}} {
        # We have to qualify the call to this supposed-ly private
        # method because Itcl (2.2) has virtual private methods!
        ::tycho::EditGraph::initializeMenubar
    }

    # Make a more pronounced highlight
    $slate configure -highlightcolor azure2 -highlightwidth 4

    # Enable selection with button 1; shift-click toggles
    $slate selector bind click vertex -button 1
    $slate selector bind click vertex -button 1 -modifiers shift -toggle

    # Enable drag-selection with button 1; shift-click toggles
    $slate selector bind drag "#background" -button 1
    $slate selector bind drag "#background" -button 1 -modifiers shift -toggle

    # Create the interactor to move selected items
    set follower [$slate interactor Follower]
    $slate selector delegate immediate selected $follower vertex \
	    -button 1 
    $slate selector delegate immediate selected $follower vertex \
	    -button 1 -modifiers shift

    # Now for some tricky stuff: we want the follower to send
    # the interaction to the model, rather than to the slate.
    # Give it the right "prefixes":
    $follower configure \
            -clickprefix "$this vertexclick" \
            -dragprefix "$this vertexdrag" \
            -releaseprefix "$this vertexrelease"

    # More tricky stuff: the selector sends selection events
    # to the model:
    $slate selector configure \
	    -clearprefix "$this selectionclear" \
	    -deselectprefix "$this deselect" \
	    -selectprefix "$this select"

    # Create a DragDropper to join terminals
    set dropper [$slate interactor DragDropper]
    $dropper bind output
    $dropper configure \
	    -halo 4 \
	    -targettags input \
	    -activatecommand "$this newclick %1 %2 %3" \
	    -dragcommand "$this newdrag %1 %2 %3" \
	    -deactivatecommand "$this newrelease %2 %3"

    # Is this needed?
    $slate configure -exportselection 0
}

########################################################################
#### clone
#
# Create another editor -- for demos only.
#
body ::tycho::EditGraph::clone {} {
    set clone [::tycho::view EditGraph \
            -layout $itk_option(-layout) \
            -graph $itk_option(-graph)]
    $clone loadLayout
}

########################################################################
#### deselect
#
body ::tycho::EditGraph::deselect {id} {
    $itk_option(-layout) publish deselect $_itemname($id)
}

########################################################################
#### loadLayout
#
# Load a new layout into the editor.
#
body ::tycho::EditGraph::loadLayout {} {
    # Clear all data here
    _clear

    # Make sure the layout is up to date
    updateLayout

    # Get vertices and edges and create
    foreach vertex [$itk_option(-graph) vertices] {
        eval [list _vertex \
                [$itk_option(-layout) vertexget $vertex]] \
                [$itk_option(-layout) vertexget $vertex]
    }
}

########################################################################
#### model
#
# Call the model. Note that this does not call the command to
# the model via Model::publish{}, so commands that are to be published
# should explitly be called via publish{}.
#
body ::tycho::EditGraph::model {method args} {
    if { $itk_option(-layout) !=  "" } {
	eval $itk_option(-layout) $method $args
    }
}

########################################################################
#### newclick
#
# Start creating a new edge. Create the edge item and remember
# it.
#
body ::tycho::EditGraph::newclick {item x y} {
puts 1
    # First we make sure that we clear the selection, since the
    # DragDropper is too dumb to do this...
    selectionclear
puts 2
    # Create the connection line
    set coords [$slate aspect $item terminal]
    set _scratch(line) [eval $slate create SmartLine $coords $x $y]

    # Set the directions of the line
    set dir [eval ::tycho::Shape::compassFromVector \
	    [$slate itemcget $item -direction]]
    $slate itemconfigure $_scratch(line) -start $dir -end $dir
    set _scratch(dir) $dir

    # Remember the source item
    set _scratch(source) $item
}

########################################################################
#### newdrag
#
# Move the end of the new edge. If the _item_ argument is null,
# then we are not over a suitable terminal item, so just move the
# end of the line. If _item_ is not null, then we are over
# an input terminal, so move the end of the line to the right
# connection point.
#
body ::tycho::EditGraph::newdrag {item x y} {
    if { $item == "" } {
	# Just move end point
	$slate reshapeto $_scratch(line) $x $y end
    } else {
	# Move end point to terminal connection point
	set coords [$slate aspect $item terminal]
	eval $slate reshapeto $_scratch(line) $coords end

	# If the line direction does not match the terminal
	# direction, change the line
	set dir [eval ::tycho::Shape::compassFromVector \
	    [$slate itemcget $item -direction]]
	set dir [::tycho::Shape::compass $dir rev]

	if { $dir != $_scratch(dir) } {
	    $slate itemconfigure $_scratch(line) -end $dir
	    set _scratch(dir) $dir
	}
    }
    # Remember the target item for newrelease{}
    set _scratch(dest) $item
}

########################################################################
#### newrelease
#
# Release the item. If we are currently over a target input terminal,
# make a conneciton in the graph. If not, just delete the line,
# since connection failed.
#
body ::tycho::EditGraph::newrelease {x y} {
    set line $_scratch(line)
    if { $_scratch(dest) == "" } {
	$slate delete $line
    } else {
	# Get the vertices and ports being connected
	set srcpar [$slate itemcget [$slate parent $_scratch(source)] -name]
	set source [$slate itemcget $_scratch(source) -name]
	set dstpar [$slate itemcget [$slate parent $_scratch(dest)] -name]
	set dest [$slate itemcget $_scratch(dest) -name]

	# Add an edge to the graph
	$itk_option(-graph) edge $srcpar $source $dstpar $dest

	# Add an edge to the layout model
	# FIXME: more options need to be propagated!!!
	set attrs {}
	foreach {opt x y z val} [eval concat [$slate itemconfigure $line]] {
	    lappend attrs $opt $val
	}
	# Inform all views _except_ this one
	eval [list $this model update $this edge \
		[list $srcpar $source $dstpar $dest] \
		[concat [$slate type $line] [$slate coords $line]]] \
		$attrs

	# Remember it
	set _itemID([list $srcpar $source $dstpar $dest]) $line
    }
}

########################################################################
#### notify
#
body ::tycho::EditGraph::notify {method args} {
    eval _$method $args
}

########################################################################
#### select
#
body ::tycho::EditGraph::select {id} {
    $itk_option(-layout) publish select $_itemname($id)
}

########################################################################
#### selectionclear
#
body ::tycho::EditGraph::selectionclear {} {
    $itk_option(-layout) publish selectionclear foo
}

########################################################################
#### updateLayout
#
#  Update the layout with current coordinates.
#
body ::tycho::EditGraph::updateLayout {} {
    foreach vertex [$itk_option(-graph) vertices] {
        set coords [$slate coords $_itemID($vertex)]
        eval [list $itk_option(-layout) vertexcoords $vertex] $coords
    }
}

########################################################################
#### vertex
#
body ::tycho::EditGraph::vertex {icon x y} {
    set name [::tycho::autoName vertex]
    set graph $itk_option(-graph)
    set icons $itk_option(-icons)

    # Add a vertex to the graph
    $graph publish vertex $name -type $icon

    # Add a vertex to the layout model
    set type  [$icons type $icon]
    set attrs [$icons iconattrs $icon]
    eval [list $this model publish vertex $name [list $type $x $y]] $attrs \
	    -tags vertex

    # Add its ports to the graph
    foreach port [$icons children port $icon] {
	$graph publish keyin $name $port
    }

    # Add the ports to the layout model
    foreach port [$icons children port $icon] {
	set type  [$icons type $icon.$port]
	set attrs [$icons portattrs $icon.$port]
	
	# When creating the port item, give it a tag which is the same
	# as its type -- that is, "input" or "output". Give it a
	# name which is the same as its name in the icon model
	eval [list $this model publish portin $name $port $type] $attrs \
		-tags [$icons portcget $icon.$port -type] \
		-name $port
    }
}

########################################################################
#### vertexclick
#
body ::tycho::EditGraph::vertexclick {tag x y args} {
    eval $itk_option(-layout) vertexclick $tag $x $y $args
}

########################################################################
#### vertexdrag
#
body ::tycho::EditGraph::vertexdrag {tag x y} {
    $itk_option(-layout) vertexdrag $tag $x $y
}

########################################################################
#### vertexrelease
#
body ::tycho::EditGraph::vertexrelease {tag x y} {
    $itk_option(-layout) vertexrelease $tag $x $y
}

########################################################################
#### withtag
#
# Return the vertice and edges with a given tag.
#
body ::tycho::EditGraph::withtag {tag} {
    set result {}
    foreach id [$slate find withtag $tag] {
	lappend result $_itemname($id)
    }
    return $result
}

###################################################################
###################################################################
####                      protected methods                    ####

########################################################################
#### _addtag
#
# Add a tag to all indicated vertices and names.
#
body ::tycho::EditGraph::_addtag {tag args} {
    foreach name $args {
	$slate addtag $tag withtag $_itemID($name)
    }
}

########################################################################
#### _clear
#
# Celar the displayed graph.
#
body ::tycho::EditGraph::_clear {} {
    catch {unset _itemname}
    catch {unset _itemID}
    $slate delete all
}

########################################################################
#### _deselect
#
# Remove an item from the selection.
#
body ::tycho::EditGraph::_deselect {name} {
    $slate select remove $_itemID($name)
}

########################################################################
#### _dtag
#
# Delete a tag from all items.
#
body ::tycho::EditGraph::_dtag {tag} {
    $slate dtag $tag
}

########################################################################
#### _edge
#
# Add a new edge to the view. This method must be called only
# by the model.
#
body ::tycho::EditGraph::_edge {name spec args} {
    set id [eval $slate create $spec $args -name $name]
    set _itemID($name) $id
    set _itemname($id) $name
}

########################################################################
#### _move
#
body ::tycho::EditGraph::_move {tag x y} {
    $slate move $tag $x $y
}

########################################################################
#### _moveclick
#
body ::tycho::EditGraph::_moveclick {tag x y} {
    eval $slate moveclick $tag $x $y args
}

########################################################################
#### _movedrag
#
body ::tycho::EditGraph::_movedrag {tag x y} {
    $slate movedrag $tag $x $y
}

########################################################################
#### _moverelease
#
body ::tycho::EditGraph::_moverelease {tag x y} {
    $slate moverelease $tag $x $y
}

########################################################################
#### _portin
#
# Add a new port to the view. This method must be called only
# by the model.
#
body ::tycho::EditGraph::_portin {context name type args} {
    set parent $_itemID($context)
    set id [eval $slate createrootchild $parent $type 0 0 $args -name $name]
    set _itemID($name) $id
    set _itemname($id) $name
}

########################################################################
#### _reshape
#
body ::tycho::EditGraph::_reshape {name x y args} {
    eval $slate reshape $_itemID($name) $x $y $args
}

########################################################################
#### _reshapeclick
#
body ::tycho::EditGraph::_reshapeclick {name x y args} {
    eval $slate reshapeclick $_itemID($name) $x $y $args
}

########################################################################
#### _reshapedrag
#
body ::tycho::EditGraph::_reshapedrag {name x y} {
    $slate reshapedrag $_itemID($name) $x $y
}

########################################################################
#### _reshaperelease
#
body ::tycho::EditGraph::_reshaperelease {name x y} {
    $slate reshaperelease $_itemID($name) $x $y
}

########################################################################
#### _select
#
# Add an item to the selection.
#
body ::tycho::EditGraph::_select {name} {
    $slate select add $_itemID($name)
}

########################################################################
#### _selectionclear
#
# Clear the selection.
#
body ::tycho::EditGraph::_selectionclear {foo} {
    $slate select clear
}

########################################################################
#### _vertex
#
# Add a new vertex to the view. This method must be called only
# by the model.
#
body ::tycho::EditGraph::_vertex {name spec args} {
    set id [eval $slate create $spec $args -name $name]
    set _itemID($name) $id
    set _itemname($id) $name
}

########################################################################
#### _vertexconfigure
#
# Configure a vertex. This method must be called only
# by the model.
#
body ::tycho::EditGraph::_vertexconfigure {name args} {
    eval $slate itemconfigure $_itemID($name) $args
}

#####################################################################
#### addIconEntry
# Add an icon entry to the menus
#
body ::tycho::EditGraph::addIconEntry {menu icons index} {
    if { $index != "" } {
	menubar add [$icons groupcget $index -label] $menu -type cascade
	foreach c [$icons children icon $index] {
	    menubar command \
		    [$icons iconcget $index.$c -label] \
		    [$icons groupcget $index -label] \
		    -command "$this vertex $index.$c 100 100"
	}
	foreach c [$icons children group $index] {
	    addIconEntry $menu $icons $index.$c
	}
    } else {
	foreach c [$icons roots icon] {
	    menubar command [$icons iconcget $c -label] $menu \
		    -command "$this vertex $c 100 100"
	}
	foreach c [$icons roots group] {
	    addIconEntry $menu $icons $c
	}
    }
}

    #####################################################################
    #####################################################################
    ####                       private methods                       ####

#####################################################################
#### initializeMenubar
# Adds entries to the menu bar specific to this class.
#
body ::tycho::EditGraph::initializeMenubar {} {
    # Add an Edit menu before the Window menu
    $myMenubar addMenu Edit -before Window -underline 0
    
    $myMenubar command {Undo} Edit -accelerator "C-x u" \
	    -underline 0 -command "$this undo"
    
    $myMenubar command {Redo} Edit -accelerator "C-x r" \
	    -underline 0 -command "$this redo"
    
    $myMenubar addSeparator Edit
    
    $myMenubar command Cut Edit -underline 0 -accelerator "C-w" \
	    -command "$this cut"
    
    $myMenubar command Copy Edit -underline 1 -accelerator "M-w" \
	    -command "$this copy"
    
    $myMenubar command Paste Edit -underline 0 -accelerator "C-y" \
	    -command "$this paste"
    
    $myMenubar addSeparator Edit
    
    $myMenubar command "Select All" Edit -underline 0 \
	    -accelerator "C-/" -command "$this selectRange 1.0 end"
    
    $myMenubar command "Unselect" Edit -underline 0 \
	    -accelerator "C-\\" -command "$this unselectRange 1.0 end"

    # Build a menu if icons from the icon index
    if { $itk_option(-icons) != "" } {
	menubar addMenu Icons -underline 0
	addIconEntry Icons $itk_option(-icons) {}
    }

    # Add a Devel menu for development use
    menubar addMenu Devel -underline 0
    menubar command {Clone} Devel \
            -command "$this clone"

    menubar addSeparator Devel

    menubar command {Show layout} Devel \
	    -command "::tycho::post \[\[$this cget -layout\] describe\]"
    menubar command {Show graph} Devel \
            -command "::tycho::post \[\[$this cget -graph\] describe\]"

}

