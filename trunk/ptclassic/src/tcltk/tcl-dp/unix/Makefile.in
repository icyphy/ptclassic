#
# This file is a Makefile for DP.  If it has the name "Makefile.in"
# then it is a template for a Makefile; to generate the actual
# Makefile, run "./configure", which is a configuration script
# generated by the "autoconf" program (constructs like "@foo@" will
# get replaced in the actual Makefile.
#
#

@SET_MAKE@

# Current DP version;  used in various names.

TCLVERSION = @TCL_VERSION@
VERSION = @DP_VERSION@

# Set the CFLAGS variable to -g if you want debug option. You can also
# specify it in the command line. E.g., type
#	make CFLAGS=-g all
#
# CFLAGS = -g @TCL_VER_DEF@ 
CFLAGS = -O @TCL_VER_DEF@ 

# The directory containing the Tcl sources and headers appropriate for
# this version of your shared library ("srcdir" will be replaced or
# has already been replaced by the configure script):
TCL_GENERIC_DIR =	@TCL_SRC_DIR@/generic

# The directory containing the Tcl library archive file appropriate
# for this version of Tk:
TCL_BIN_DIR = @TCL_BIN_DIR@

# Libraries to use when linking:
LIBS = @TCL_BUILD_LIB_SPEC@ @TCL_LIBS@ -lc

#----------------------------------------------------------------
# The information below is modified by the configure script when
# Makefile is generated from Makefile.in.  You shouldn't normally
# modify any of this stuff by hand.
#----------------------------------------------------------------

CC = 			@CC@
SHLIB_CFLAGS =		@SHLIB_CFLAGS@
SHLIB_LD =		@SHLIB_LD@
SHLIB_SUFFIX =		@SHLIB_SUFFIX@
SHLIB_VERSION =		@SHLIB_VERSION@
SRC_DIR =		@SRC_DIR@
GENERIC_DIR =		@SRC_DIR@/generic
UNIX_DIR =		@SRC_DIR@/unix
OBJ_DIR  =		@SRC_DIR@/unix/objs
LLIB     =              @SRC_DIR@/library
AC_FLAGS =		@DEFS@

CC_SWITCHES = $(CFLAGS) -I${TCL_GENERIC_DIR} -I${SRC_DIR} ${SHLIB_CFLAGS} \
	@OS_DEF@ $(AC_FLAGS)

DP_LIB_FILE = @DP_LIB_FILE@

OBJS = \
	$(OBJ_DIR)/dpChan.o \
	$(OBJ_DIR)/dpCmds.o \
	$(OBJ_DIR)/dpInit.o \
	$(OBJ_DIR)/dpRPC.o \
	$(OBJ_DIR)/dpTcp.o \
	$(OBJ_DIR)/dpSock.o \
	$(OBJ_DIR)/dpUdp.o \
	$(OBJ_DIR)/dpSerial.o \
	$(OBJ_DIR)/dpUnixSock.o \
	$(OBJ_DIR)/dpUnixSerial.o \
	$(OBJ_DIR)/dpUnixInit.o \
	$(OBJ_DIR)/dpUnixEmail.o \
	$(OBJ_DIR)/dpLocks.o \
	$(OBJ_DIR)/dpPlugF.o \
	$(OBJ_DIR)/dpFilters.o \
	$(OBJ_DIR)/dpIdentity.o \
	$(OBJ_DIR)/dpPackOff.o \
	$(OBJ_DIR)/dpIPM.o

all: $(DP_LIB_FILE) movefilter

$(DP_LIB_FILE): $(OBJ_DIR) $(OBJS) 
	rm -f $(DP_LIB_FILE)
	@DP_MAKE_LIB@

dpsh: $(DP_LIB_FILE) $(OBJ_DIR)/dpAppInit.o movefilter
	$(CC) -o dpsh $(OBJ_DIR)/dpAppInit.o $(OBJS) $(LIBS)

puredpsh: $(DP_LIB_FILE) $(OBJ_DIR)/dpAppInit.o movefilter
	purify $(CC) -o dpsh $(OBJ_DIR)/dpAppInit.o $(OBJS) $(LIBS)

#----------------------------------------------------------------------

$(OBJ_DIR)/dpAppInit.o: $(UNIX_DIR)/dpAppInit.c
	$(CC) $(CC_SWITCHES) -c $(UNIX_DIR)/dpAppInit.c -o \
	    $(OBJ_DIR)/dpAppInit.o

$(OBJ_DIR)/dpChan.o: $(GENERIC_DIR)/dpChan.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpChan.c -o \
	    $(OBJ_DIR)/dpChan.o

$(OBJ_DIR)/dpCmds.o: $(GENERIC_DIR)/dpCmds.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpCmds.c -o \
	    $(OBJ_DIR)/dpCmds.o

$(OBJ_DIR)/dpSock.o: $(GENERIC_DIR)/dpSock.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpSock.c -o \
	    $(OBJ_DIR)/dpSock.o

$(OBJ_DIR)/dpSerial.o: $(GENERIC_DIR)/dpSerial.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpSerial.c -o \
	    $(OBJ_DIR)/dpSerial.o

$(OBJ_DIR)/dpIPM.o: @IPM@
	$(CC) $(CC_SWITCHES) -c @IPM@ -o \
	    $(OBJ_DIR)/dpIPM.o

$(OBJ_DIR)/dpTcp.o: @TCP@
	$(CC) $(CC_SWITCHES) -c @TCP@ -o \
	    $(OBJ_DIR)/dpTcp.o

$(OBJ_DIR)/dpUdp.o: @UDP@
	$(CC) $(CC_SWITCHES) -c @UDP@ -o \
	    $(OBJ_DIR)/dpUdp.o

$(OBJ_DIR)/dpRPC.o: $(GENERIC_DIR)/dpRPC.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpRPC.c -o \
	    $(OBJ_DIR)/dpRPC.o

$(OBJ_DIR)/dpInit.o: $(GENERIC_DIR)/dpInit.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpInit.c -o \
	    $(OBJ_DIR)/dpInit.o

$(OBJ_DIR)/dpUnixInit.o: $(UNIX_DIR)/dpInit.c
	$(CC) $(CC_SWITCHES) -c $(UNIX_DIR)/dpInit.c -o \
	    $(OBJ_DIR)/dpUnixInit.o

$(OBJ_DIR)/dpUnixSerial.o: $(UNIX_DIR)/dpSerial.c
	$(CC) $(CC_SWITCHES) -c $(UNIX_DIR)/dpSerial.c -o \
	    $(OBJ_DIR)/dpUnixSerial.o

$(OBJ_DIR)/dpUnixSock.o: $(UNIX_DIR)/dpSock.c
	$(CC) $(CC_SWITCHES) -c $(UNIX_DIR)/dpSock.c -o \
	    $(OBJ_DIR)/dpUnixSock.o

$(OBJ_DIR)/dpUnixEmail.o: $(UNIX_DIR)/dpEmail.c
	$(CC) $(CC_SWITCHES) -c -DLLIB=\"$(LLIB)\" $(UNIX_DIR)/dpEmail.c -o \
	    $(OBJ_DIR)/dpUnixEmail.o

$(OBJ_DIR)/dpLocks.o: $(UNIX_DIR)/dpLocks.c
	$(CC) $(CC_SWITCHES) -DSOURCE=\"dp\" -c $(UNIX_DIR)/dpLocks.c -o \
	    $(OBJ_DIR)/dpLocks.o

$(OBJ_DIR)/dpIdentity.o: $(GENERIC_DIR)/dpIdentity.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpIdentity.c -o \
	    $(OBJ_DIR)/dpIdentity.o

$(OBJ_DIR)/dpPlugF.o: $(GENERIC_DIR)/dpPlugF.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpPlugF.c -o \
	    $(OBJ_DIR)/dpPlugF.o

$(OBJ_DIR)/dpFilters.o: $(GENERIC_DIR)/dpFilters.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpFilters.c -o \
	    $(OBJ_DIR)/dpFilters.o

dpfilter: $(OBJ_DIR)/dpEFilter.o $(OBJ_DIR)/dpLocks.o
	$(CC) $(CC_SWITCHES) $(OBJ_DIR)/dpEFilter.o \
	    $(OBJ_DIR)/dpLocks.o -o dpfilter 

$(OBJ_DIR)/dpPackOff.o: $(GENERIC_DIR)/dpPackOff.c
	$(CC) $(CC_SWITCHES) -c $(GENERIC_DIR)/dpPackOff.c -o \
	    $(OBJ_DIR)/dpPackOff.o

$(OBJ_DIR)/dpEFilter.o: $(UNIX_DIR)/dpEFilter.c 
	$(CC) $(CC_SWITCHES) -c $(UNIX_DIR)/dpEFilter.c -o \
	    $(OBJ_DIR)/dpEFilter.o  

#----------------------------------------------------------------------

$(OBJ_DIR):
	if [ ! -d objs ]; then \
	    mkdir objs; \
	fi

# This is necessary for the email channel
movefilter: dpfilter
	cp ./dpfilter $(LLIB)

clean:
	rm -f dpsh $(OBJ_DIR)/*.o *${SHLIB_SUFFIX} $(LLIB)/dpfilter dpfilter \
		pkgIndex.tcl confdefs.h

tests: $(DP_LIB_FILE)
	cd ../tests; @TCL_SRC_DIR@/unix/tclsh all

install:
	@echo You didn't read the README, did you?

Makefile: Makefile.in
	./config.status

distclean: clean
	rm -rf objs config.cache config.log config.status lib.exp \
		$(LLIB)/dpfilter Makefile 

