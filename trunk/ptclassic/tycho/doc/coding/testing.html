<!-- $Id$-->
<html>
<head>
<title>Testing Tycho</title>
</head>
<body bgcolor="#faf0e6">
<h1><A NAME="Testing Tycho">Testing Tycho</A></h1>
<HR>
This page is primarily for Tycho Developers.  Some of the commands
mentioned below are not included in Tycho.
 <P>Contents:
<MENU>
<LI> <A HREF="#test suite">Test Suite</A>
<LI> <A HREF="#testing documentation">Testing Documentation</A>
<LI> <A HREF="#testing the tycho script">Testing the tycho Script</A>
</MENU>

<H2><A NAME="test suite">Test Suite</A></H2>

We have included recursion tests for some of the code.  Usually, 
wherever there is a Itcl file, the tests are in the <CODE>test</CODE>
directory.

<H3>Running the tests</H3>
There are several ways to run the tests
<OL>

<LI> Open a test file such as <A
HREF="../../kernel/test/testStack.itcl"><CODE>$TYCHO/kernel/test/testStack.itcl</CODE></A>  with Tycho and then evaluate the contents of the file with
the <CODE>Evaluate</CODE> choice from the <CODE>File</CODE> menu (<CODE>C-x C-r</CODE>.


<LI> The <A HREF="../../mk/tycommon.mk"><CODE>$TYCHO/mk/tycommon.mk</CODE></A>
file automagically generates two itcl files:
<DL>
<DT> <CODE>all.itcl</CODE>
<DD> This file merely sources all of the *.itcl files in the current
directory.
<DT> <CODE>alltests.itcl</CODE>
<DD> This file sources all of the files that are listed as test files
in the <CODE>makefile</CODE>.

<DT> <A HREF="../../kernel/test/alltychotests.tcl"><CODE>$TYCHO/kernel/test/alltychotests.tcl</CODE></A>
<DD> <CODE>alltychotests.tcl</CODE> will run all the <CODE>alltests.itcl</CODE>
files.  <CODE>$TYCHO/makefile</CODE> has two rules:
	<DL>
	<DT> <CODE>make alltests</CODE>
	<DD> Run all the tests in a vanilla <CODE>tycho</CODE>

	<DT> <CODE>make alltests.ptiny</CODE>
	<DD> Run all the tests in a <CODE>tycho -ptiny</CODE>

	</DL>
</DL>



</DL>
After running <CODE>make sources</CODE>, you can open up either of these files
and then evaluate it, which will run all the tests in that directory.


<LI> The tests can also be run by cding into a <CODE>test</CODE>
directory and typing <CODE>make</CODE> from a shell.  To try this out,
click on the tcl code below:
<tcl><pre>
::tycho::execModal {make} "[file join $TYCHO kernel test]"
</pre></tcl>

<LI> The tycho test suite can be run from the Tycho Toplevel directory
with the command: <CODE>make tests</CODE>

</OL>


<H3>Writing your own tests</H3>

The test suite infrastructure is based on the Itcl test suite code,
which is in turn based on the Tcl test suite code.

 <P>The file <A HREF="../../kernel/test/testDefs.tcl"><CODE>$TYCHO/kernel/test/testDefs.tcl</CODE></A> defines the tcl proc <CODE>test</CODE>.

 <P><CODE>test</CODE> takes four argument:
<OL>
<LI> The name of the test: <CODE>foo-1.0</CODE>
  <br> The name of the test should strictly follow the format below.
	The Tcl tests that come with the tcl distribution follow a similar
	format, so unless there is a strong need to not follow the format,
	please stick with what works.
	<MENU>
	<LI> The first part of
	name of the test should reflect the command that is
	being tested.  

	<LI> The test number should be separated by a dash '<CODE>-</CODE>'

	<LI> Each test number consists of a major value and a minor value,
	separated by a dot.  Usually the major value changes as different
	parts of the command are being tested.  The minor value changes
	for different tests for the particular part of the command under test.

	<LI> Test numbers usually start with <CODE>1</CODE>, though if
	you are
	doing setup, you can start with <CODE>0</CODE>.

	<LI> If you go back later and want to stick a test in between
	<CODE>foo-1</CODE> and <CODE>foo-2</CODE>, you can always call
	your new test <CODE>foo-1.1</CODE>
	</MENU>


<LI> The test description, usually a single sentence.

<LI> The contents of the test, usually tcl code that does the action to
be tested.  The last line of the contents should return a value.

<LI> The results to be compared against.
</OL>

Below is a sample piece of code that sources the
<CODE>testDefs.tcl</CODE> file and then runs one test.  The code below
has the incorrect value return results to be compared against, so the
test suite properly indicates that the test failed.

<tcl><pre>
if {[string compare test [info procs test]] == 1} then { 
    source [file join $TYCHO kernel test testDefs.tcl]
} {}
test testExample-1.1 {This is the first test example, it does very little} {
	catch {this is an error} errMsg1
	set a "this is the value of a"
	list $errMsg1 $a
} {{invalid command name "this"} {this is NOT the value of a}}
</pre></tcl>

<H3>Parts of a test file</H3>
Test files should be located in the <CODE>test</CODE> directory.

 <P>It is better to have many small test files as opposed to a few
large test files so that other developers can quickly find the tests
for the class they are working with.  Usually tests for the class
<CODE>Foo</CODE> are found in the file <CODE>test/testFoo.itcl</CODE>

 <P>See <A HREF="../../kernel/test/testGraph.itcl"><CODE>$TYCHO/kernel/test/testGraph.itcl</CODE></A> for an example test file.

 <P>Each test file should have the following parts:
<OL>

<LI> The name of the test file should being with the word <CODE>test</CODE>.
For example, if we were testing the tcl <CODE>foo</CODE> command, then
the file would be named <CODE>testFoo.itcl</CODE>.  The extension of the file
is either <CODE>.tcl</CODE> or <CODE>.itcl</CODE>:
<MENU>
<LI> <CODE>.tcl</CODE> if the file can be sourced in a <CODE>tclsh</CODE>
	that does not contain Itcl.
	<CODE>$TYCHO/kernel/test/testPath.tcl</CODE> is an example.

<LI> <CODE>.itcl</CODE> if the file contains Itcl constructs or tests
	Itcl classes. 
</MENU>
Most of the tests are <CODE>.itcl</CODE> files

<LI> The Copyright

<LI> The code that sources testDefs.tcl:
<PRE>
if {[string compare test [info procs test]] == 1} then { 
    source [file join $TYCHO kernel test testDefs.tcl]
} {}
</PRE>


<LI> A line that the user can uncomment if they want the test system to
produce verbose messages:
<PRE>
#set VERBOSE 1
</PRE>


<LI> The individual tests, which should loosely follow the Tycho 
file format standard:
<PRE>
############################################################################
#### Foo
test Foo-1.1 {Test out Foo} {

} {}
</PRE>

</OL>

<H3><A NAME="testing modal dialog widgets">Testing Modal Dialog Widgets</A></H3>
Testing modal dialog widgets and the methods that use them is tricky because 
we want the test suite to be able to just 'do the right thing' and 
invoke the actions of an arbitrary method.

 <P>The problem is that when a model dialog box comes up, execution
halts, so during testing the user would need to know what button to
hit.  
 <P>As a workaround, we have designed a system that can
automatically invoke a button during testing.  If we are testing, then
<CODE>Dialog::wait</CODE> checks to see if <CODE>TY_TEST_SCRIPT</CODE>
exists.  If <CODE>TY_TEST_SCRIPT</CODE> exists, then
<CODE>Dialog::wait</CODE> assumes that it is a script, substitutes in the
dialog name for <CODE>%O</CODE> and then evals the script at level
<CODE>#0</CODE>
The script can do anything, usually it just invokes a button and then
unsets <CODE>TY_TEST_SCRIPT</CODE>.  For example, the
<A HREF="../../kernel/test/testWidgets.itcl"><CODE>$TYCHO/kernel/test/testWidgets.itcl</CODE></A> script includes a test for <A HREF="../../kernel/YesNoQuery.itcl"><CODE>YesNoQuery</CODE></A>:
<tcl><pre>
if {[string compare test [info procs test]] == 1} then { 
    source $TYCHO/kernel/test/testDefs.tcl
} {}

test YesNoQuery-2.1 {Test the modal ::tycho::askuser proc} {
    set TY_TEST_SCRIPT {
        %0 invoke yes
        unset TY_TEST_SCRIPT
    }
    ::tycho::askuser "Are you awake?"
} 1
</pre></tcl>
	
<H2>Writing Testable Code</H2>
Below are some hints about writing code that can be tested.
<MENU>
	<LI> If a method creates a window, and the window is present
	after the method ends, then the method should probably return
	the name of the window.  This makes it easier for callers
	and testing scripts to perform operations on the window.

	<LI> Separating interface and implementation can help.
	If a largish operation brings up lots of windows, it
	can help if there is a method that performs the interface
	operations which then calls a series of smaller methods.
	It is easier to test a series of small scripts that to
	test a large monolithic method.
</MENU>

<HR>
<H2><A NAME="testing documentation">Testing Documentation</A></H2>

The Tycho documentation is written in html.  There are several tools
that can be used.
<H3>weblint</H3>

Weblint tells the user about html errors.  Weblint can be obtained
from <A
HREF="ftp://ftp.cre.canon.co.uk/pub/weblint/weblint.tar.gz"><CODE>ftp://ftp.cre.canon.co.uk/pub/weblint/weblint.tar.gz</CODE></A>
To run <CODE>weblint</CODE>:
<PRE>
cd $TYCHO
make weblint
</PRE>

<H3>htmlchek</H3>

Htmlchek is another tool that tells the user about html errors.
<CODE>htmlchek</CODE> also checks for bad links.  The
<CODE>htmlchek</CODE> output is a little hard to read, so we tend to
use <CODE>weblint</CODE> for checking individual files.
<CODE>htmlchek</CODE> cat be obtained from
<A HREF="ftp://ftp.cs.buffalo.edu/pub/htmlchek/"><CODE>ftp://ftp.cs.buffalo.edu/pub/htmlchek/</CODE></A>

<P> The best way to run <CODE>htmlchek</CODE> is to create a sample
distribution, create the codeDoc files and then run <CODE>htmlchek</CODE>

<OL>
<LI> Create the test distribution:
<PRE>
cd /users/ptdesign/adm/gen-latest; make clean; make
</PRE>

<LI> Reset <CODE>TYCHO</CODE> to point to the test distribution:
<PRE>
setenv TYCHO /users/ptdesign/adm/dists/tycho-latest
cd $TYCHO
</PRE>

<LI> Run <CODE>make install</CODE>.  This will make the itcldocs twice, which
will populate the <CODE>doc/codeDoc</CODE> directories.  You need to make
the itcldocs twice so that the cross references are correct

<LI> Run <CODE>make htmlchek</CODE>

</OL>



The output ends up in five files
<MENU>
<LI> <CODE>htmlchekout.ERR</CODE> - HTML usage errors
<LI> <CODE>htmlchekout.NAME</CODE> - Locations in the specified files
that ware not referenced by any of those files
<LI> <CODE>htmlchekout.HREF</CODE> - References from the specified files
that are not found in the files.  This file is by far the most important
file to look at.
<LI> <CODE>htmlchekout.SRC</CODE> - References to online images.
<LI> <CODE>htmlchekout.MAP</CODE> - Cross dependency information.
</MENU>
sh	
<P> All of the references in <CODE>htmlchekout.HREF</CODE> that point
to <CODE>.html</CODE> files should be checked.  References to non-html
files appear in <CODE>htmlchekout.HREF</CODE> because the non-html
files were not included in the list of files that
<CODE>htmlchek</CODE> ran on.  One quick way to search all the the <CODE>*.html</CODE> files is
<PRE>
cd $TYCHO
grep mystring `find . -name "*.html" -print`
</PRE>

<H3>Spellchecking</H3>
Checking the spelling in the html files can be done with:
<PRE>
cd $TYCHO
spell `find . -name "*.html" -print`
</PRE>

<H3>Checking embedded tcl</H3>

Tycho extends html with <CODE>&lt;TCL&gt; . . . &lt;TCL&gt;</CODE>
tags.  In the Tycho HTML viewer, when the contents of these tags are
moused on, the embedded tcl code is executed.

 <P>To test all of the embedded tcl, the script
<CODE>$TYCHO/adm/bin/chktclpre</CODE> will generated a
<CODE>tclpre.html</CODE> file that contains all of the embedded tcl.
This script is not shipped with Tycho.

 <P>After running <CODE>chktclpre</CODE>, start up tycho, view
<CODE>tclpre.html</CODE> and mouse on each block of embedded tcl code.
Note that some blocks depend on the widgets created in earlier blocks.
If you run into problems, you can follow the hyperlink in
<CODE>tclpre.html</CODE> to the source html file.


<H3>Checking for bogus copyright SCCS keywords</H3>

Run <CODE>~ptdesign/adm/copyright/chkq $TYCHO</CODE> to print out
the names of files that might have bogus percentQpercent values.
 <P>
Then run <CODE>~ptdesign/adm/bin/sccsadmin</CODE> on each file that
has no value for percentQpercent substituted in.

<H3>Check the distribution for bogus files</H3>
Run the following makefile rules and commands
<DL>
<DT> <CODE>make realclean</CODE>

<DD> This will remove the <CODE>tclIndex</CODE> files and the files in
<CODE>doc/codeDoc</CODE>.  The reason to remove the
<CODE>codeDoc</CODE> files is so that we don't ship html files for any
classes that have been removed.

<DT> <CODE>make install</CODE>
<DD> This will recreate the <CODE>tclIndex</CODE> files and the
<CODE>doc/codeDoc</CODE> files.

<DT> <CODE>make checkjunk</CODE>
<DD> Look for files in the distribution that should not be there.

<DT> <CODE>adm/bin/chkgifs</CODE>
<DD> This file looks for gif files that are not used by html files
in the distribution.

</DL> 

<H2><A NAME="testing the tycho script">Testing the tycho script</A></H2>

The <A HREF="../../bin/tycho"><CODE>$TYCHO/bin/tycho</CODE></A> script
can be tested with the <A
HREF="../../kernel/test/chktycho"><CODE>$TYCHO/kernel/test/chktycho</CODE></A>
script.

 <P>This script calls <CODE>tycho</CODE> with all the various
combinations of command line arguments.  <CODE>chktycho</CODE> adds a
line to <A
HREF="~/.Tycho/tychorc.tcl"><CODE>~/.Tycho/tychorc.tcl</CODE></A> so
that <CODE>tycho</CODE> is exitted after a few seconds.  This allows
the script to test many invocations of <CODE>tycho</CODE> without user
intervention.  However to test the <CODE>-debug</CODE> option, the
user must type <CODE>cont</CODE> in the gdb window.

<p>
<a href="../../doc/index.html">Tycho Home Page</a><br>
<HR>
Copyright &#169 1996-%Q%, The Regents of the University of California.
All rights reserved. 
<br> Last updated: $Date$, comments to:
<author>tycho@eecs.berkeley.edu</author> </body> </html>
